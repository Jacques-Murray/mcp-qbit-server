# Docker Compose Example
# This demonstrates how to run the MCP qBittorrent Server with Docker

version: '3.8'

services:
  # qBittorrent instance (optional - if you don't have one running)
  qbittorrent:
    image: linuxserver/qbittorrent:latest
    container_name: qbittorrent
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
      - WEBUI_PORT=8080
    volumes:
      - ./qbittorrent/config:/config
      - ./qbittorrent/downloads:/downloads
    ports:
      - "8080:8080"  # WebUI
      - "6881:6881"  # Torrents
      - "6881:6881/udp"
    restart: unless-stopped
    networks:
      - mcp-network

  # MCP qBittorrent Server
  mcp-qbit-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-qbit-server
    environment:
      - NODE_ENV=production
      - PORT=8000
      - QBIT_BASE_URL=http://qbittorrent:8080
      - QBIT_USERNAME=${QBIT_USERNAME:-admin}
      - QBIT_PASSWORD=${QBIT_PASSWORD:-adminpass}
      - QBIT_TIMEOUT=10000
    ports:
      - "8000:8000"
    depends_on:
      - qbittorrent
    restart: unless-stopped
    networks:
      - mcp-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # nginx reverse proxy with SSL
  nginx:
    image: nginx:alpine
    container_name: mcp-nginx
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./ssl:/etc/ssl:ro
      - nginx-logs:/var/log/nginx
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - mcp-qbit-server
    restart: unless-stopped
    networks:
      - mcp-network

networks:
  mcp-network:
    driver: bridge

volumes:
  nginx-logs:

# Usage:
# 1. Create a .env file with your credentials:
#    QBIT_USERNAME=admin
#    QBIT_PASSWORD=your_secure_password
#
# 2. Start all services:
#    docker-compose up -d
#
# 3. Check logs:
#    docker-compose logs -f mcp-qbit-server
#
# 4. Stop services:
#    docker-compose down
#
# 5. Connect to the API:
#    curl https://mcp-qbit.example.com/health
